# Notification Setup Guide

## üîî Configure Notifications for Security Patches

The Security Automation Platform can send notifications via **Slack**, **Email**, and **GitHub** when patches are generated.

---

## üì± Slack Notifications

### Setup Steps

1. **Create Slack Incoming Webhook**
   - Go to https://api.slack.com/apps
   - Click "Create New App" ‚Üí "From scratch"
   - Name it "Security Automation"
   - Select your workspace
   - Go to "Incoming Webhooks" ‚Üí Enable
   - Click "Add New Webhook to Workspace"
   - Select channel (e.g., `#security-alerts`)
   - Copy the Webhook URL

2. **Configure Environment Variable**
   ```bash
   export SLACK_WEBHOOK_URL="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
   ```

3. **For Docker**
   ```yaml
   # docker-compose.yml
   services:
     correlation-engine:
       environment:
         - SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
   ```

### Notification Format
```
ü§ñ Security Patch Generated

Vulnerability:   SQL Injection
Severity:        üî¥ HIGH
File:           `/src/UserController.java`
Line:            45
Confidence:      ‚úÖ HIGH
Provider:        ollama

Explanation: Converted string concatenation to parameterized queries...

[View Dashboard] [View API Docs]
```

---

## üìß Email Notifications

### Setup Steps

1. **Gmail (Recommended)**
   - Enable 2-Factor Authentication
   - Generate App Password: https://myaccount.google.com/apppasswords
   - Copy the 16-character password

2. **Configure Environment Variables**
   ```bash
   export SMTP_SERVER="smtp.gmail.com"
   export SMTP_PORT="587"
   export SMTP_USER="your-email@gmail.com"
   export SMTP_PASSWORD="your-app-password"
   export EMAIL_FROM="security@yourcompany.com"
   export EMAIL_TO="dev1@company.com,dev2@company.com"
   ```

3. **For Other Email Providers**
   ```bash
   # Outlook
   export SMTP_SERVER="smtp-mail.outlook.com"
   export SMTP_PORT="587"
   
   # Yahoo
   export SMTP_SERVER="smtp.mail.yahoo.com"
   export SMTP_PORT="587"
   
   # Custom SMTP
   export SMTP_SERVER="mail.yourcompany.com"
   export SMTP_PORT="25"  # or 587, 465
   ```

4. **For Docker**
   ```yaml
   # docker-compose.yml
   services:
     correlation-engine:
       environment:
         - SMTP_SERVER=smtp.gmail.com
         - SMTP_PORT=587
         - SMTP_USER=your-email@gmail.com
         - SMTP_PASSWORD=your-app-password
         - EMAIL_TO=dev1@company.com,dev2@company.com
   ```

### Notification Format
Beautiful HTML email with:
- Gradient header
- Vulnerability details table
- Color-coded severity/confidence
- Explanation text
- "View Dashboard" button
- Professional footer

---

## üêô GitHub Notifications

### Setup Steps

1. **Create GitHub Personal Access Token**
   - Go to https://github.com/settings/tokens
   - Click "Generate new token (classic)"
   - Name: "Security Automation"
   - Scopes:
     - ‚úÖ `repo` (Full control of repositories)
     - ‚úÖ `write:discussion` (Write discussions)
   - Generate and copy token

2. **Configure Environment Variables**
   ```bash
   export GITHUB_TOKEN="ghp_xxxxxxxxxxxxxxxxxxxx"
   export GITHUB_REPO="your-org/your-repo"
   ```

3. **For Docker**
   ```yaml
   # docker-compose.yml
   services:
     correlation-engine:
       environment:
         - GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxx
         - GITHUB_REPO=your-org/your-repo
   ```

### Notification Format
GitHub Issue or PR Comment:
```markdown
## ü§ñ Security Patch Generated

**Vulnerability:** SQL Injection
**Severity:** HIGH  
**File:** `src/UserController.java`  
**Line:** 45  
**Confidence:** HIGH  
**Provider:** ollama

### Explanation
Converted string concatenation to parameterized queries to prevent SQL injection...

### Original Code
```java
String sql = "SELECT * FROM users WHERE id=" + userId;
```

### Fixed Code
```java
String sql = "SELECT * FROM users WHERE id=?";
PreparedStatement stmt = connection.prepareStatement(sql);
stmt.setString(1, userId);
```

---
*Generated by Security Automation Platform on 2025-01-24 10:30:00*
```

---

## ‚öôÔ∏è Configuration Options

### Complete Environment Variables

```bash
# Slack
export SLACK_WEBHOOK_URL="https://hooks.slack.com/services/..."

# Email
export SMTP_SERVER="smtp.gmail.com"
export SMTP_PORT="587"
export SMTP_USER="your-email@gmail.com"
export SMTP_PASSWORD="your-app-password"
export EMAIL_FROM="security@yourcompany.com"
export EMAIL_TO="dev1@company.com,dev2@company.com,dev3@company.com"

# GitHub
export GITHUB_TOKEN="ghp_xxxxxxxxxxxxxxxxxxxx"
export GITHUB_REPO="owner/repository"

# Dashboard URLs (for notification links)
export DASHBOARD_URL="http://localhost:8000"
export API_URL="http://localhost:8000"
```

### Docker Compose Example

```yaml
version: '3.8'

services:
  correlation-engine:
    build: ./correlation-engine
    environment:
      # LLM Configuration
      - OLLAMA_HOST=http://ollama:11434
      - LLM_PROVIDER=ollama
      - OLLAMA_MODEL=deepseek-coder:6.7b-instruct
      
      # Notifications - Slack
      - SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK
      
      # Notifications - Email
      - SMTP_SERVER=smtp.gmail.com
      - SMTP_PORT=587
      - SMTP_USER=security@company.com
      - SMTP_PASSWORD=app-password-here
      - EMAIL_TO=dev-team@company.com
      
      # Notifications - GitHub
      - GITHUB_TOKEN=ghp_your_token_here
      - GITHUB_REPO=your-org/your-repo
      
      # URLs
      - DASHBOARD_URL=https://security.yourcompany.com
      - API_URL=https://api.security.yourcompany.com
```

---

## üß™ Testing Notifications

### Test Slack
```bash
curl -X POST http://localhost:8000/api/test/slack-notification
```

### Test Email
```bash
curl -X POST http://localhost:8000/api/test/email-notification
```

### Test All Channels
```bash
curl -X POST http://localhost:8000/api/test/notifications
```

### Generate Real Patch (Triggers Notifications)
```bash
curl -X POST http://localhost:8000/api/v1/vulnerabilities/1/generate-patch \
  -H "Content-Type: application/json"
```

---

## üìä Notification Triggers

Notifications are sent when:

1. **Single Patch Generated**
   - Via API: `POST /api/v1/vulnerabilities/{id}/generate-patch`
   - Via Dashboard: Click "ü§ñ Generate Patch" button

2. **Bulk Patches Generated**
   - Via API: `POST /api/v1/scans/{scan_id}/generate-patches`
   - Sends summary notification

3. **Patch Testing Complete**
   - After automated testing in isolated branch
   - Includes test results

---

## üîí Security Best Practices

1. **Never commit credentials to git**
   ```bash
   # Add to .gitignore
   .env
   **/secrets.env
   ```

2. **Use environment files**
   ```bash
   # .env.local
   SLACK_WEBHOOK_URL=...
   SMTP_PASSWORD=...
   GITHUB_TOKEN=...
   ```

3. **Load in Docker**
   ```bash
   docker-compose --env-file .env.local up
   ```

4. **Rotate tokens regularly**
   - GitHub tokens: Every 90 days
   - SMTP passwords: When team members leave
   - Slack webhooks: If compromised

5. **Use secret management in production**
   - AWS Secrets Manager
   - HashiCorp Vault
   - Azure Key Vault
   - Google Secret Manager

---

## üé® Customization

### Custom Slack Message Format

Edit `app/services/notifications.py`:

```python
def _notify_slack(self, patch_data):
    message = {
        "text": f"Patch generated for {patch_data['vulnerability_type']}",
        "blocks": [
            # Custom blocks here
        ]
    }
```

### Custom Email Template

Edit `app/services/notifications.py`:

```python
def _notify_email(self, patch_data):
    html_content = f"""
    <!-- Custom HTML template -->
    """
```

---

## üìà Notification Analytics

Track notification delivery:

```bash
# Check logs
docker logs security-correlation | grep "notification"

# API endpoint for notification history
curl http://localhost:8000/api/notifications/history
```

---

## üö® Troubleshooting

### Slack Not Receiving
- ‚úÖ Verify webhook URL is correct
- ‚úÖ Check webhook hasn't been revoked
- ‚úÖ Test with curl:
  ```bash
  curl -X POST $SLACK_WEBHOOK_URL \
    -H 'Content-Type: application/json' \
    -d '{"text":"Test message"}'
  ```

### Email Not Sending
- ‚úÖ Verify SMTP credentials
- ‚úÖ Check app password (not account password)
- ‚úÖ Enable "Less secure app access" if needed
- ‚úÖ Check spam folder
- ‚úÖ Test SMTP connection:
  ```bash
  telnet smtp.gmail.com 587
  ```

### GitHub Not Posting
- ‚úÖ Verify token has correct scopes
- ‚úÖ Check repository name format: `owner/repo`
- ‚úÖ Ensure token hasn't expired
- ‚úÖ Test token:
  ```bash
  curl -H "Authorization: token $GITHUB_TOKEN" \
    https://api.github.com/user
  ```

---

## üéØ Next Steps

1. ‚úÖ Configure at least one notification channel
2. ‚úÖ Test notifications with sample patch
3. ‚úÖ Customize message templates
4. ‚úÖ Set up notification rules/filters
5. ‚úÖ Monitor notification delivery

For more help, see:
- [Phase 3 Documentation](./PHASE3-LLM-PATCHING.md)
- [API Documentation](http://localhost:8000/docs)
- [Slack API Docs](https://api.slack.com/messaging/webhooks)
